<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>日本の島ガチャ【レアリティ機能付き】</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: "M PLUS Rounded 1c", sans-serif;
      }
      .card-reveal {
        animation: reveal 0.8s cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      @keyframes reveal {
        0% {
          transform: scale(0.95);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .gacha-button {
        transition: all 0.3s ease;
      }
      .gacha-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      .gacha-button:active {
        transform: translateY(1px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.4);
      }
      .modal-enter {
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* SSR背景のアニメーション */
      @keyframes rainbow-flow {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* レアリティごとの背景スタイル */
      .rarity-n-bg {
        background-color: #f8fafc; /* slate-50 */
      }
      .rarity-r-bg {
        background: linear-gradient(135deg, #d1fae5, #ffffff); /* green-100 to white */
      }
      .rarity-sr-bg {
        background: linear-gradient(135deg, #fef08a, #fef9c3); /* yellow-200 to yellow-100 */
      }
      .rarity-ssr-bg {
        background: linear-gradient(-45deg, #fbcfe8, #a5b4fc, #81e6d9, #fef08a);
        background-size: 400% 400%;
        animation: rainbow-flow 8s ease infinite;
      }

      .rarity-n-text {
        color: #64748b;
      } /* slate-500 */
      .rarity-r-text {
        color: #059669;
      } /* green-600 */
      .rarity-sr-text {
        color: #b45309;
      } /* amber-700 */
      .rarity-ssr-text {
        color: white;
        font-weight: 900;
        text-shadow: 0 0 8px #ffd700, 2px 2px 4px rgba(0, 0, 0, 0.6);
      }
    </style>
  </head>
  <body class="bg-gradient-to-b from-sky-300 to-blue-500 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md mx-auto text-center">
      <header class="mb-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-shadow-lg"><span class="text-yellow-300">日本の島</span>ガチャ</h1>
        <p class="text-white mt-2 font-medium">今日の島はどこだ？【レアリティ機能付き】</p>
      </header>

      <main id="result-card" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 min-h-[300px] flex flex-col justify-center items-center transition-all duration-300 relative">
        <div id="initial-state" class="text-center">
          <div class="text-6xl mb-4 animate-bounce">🏝️</div>
          <p class="text-xl font-bold text-gray-700">ボタンを押して<br />ガチャを引いてみよう！</p>
          <div id="loading-indicator" class="mt-4 text-blue-500 font-bold">島データをロード中...</div>
        </div>
        <div id="result-state" class="hidden text-center w-full h-full">
          <p id="rarity-display" class="font-bold text-2xl mb-2"></p>
          <div id="new-badge" class="absolute top-2 right-2 bg-pink-500 text-white font-bold text-xs py-1 px-3 rounded-full transform rotate-12 hidden">NEW!</div>
          <h2 id="island-name" class="text-4xl font-bold text-gray-800 mb-1"></h2>
          <p id="island-prefecture" class="text-lg font-semibold text-sky-600 mb-4"></p>
          <p id="island-description" class="text-base text-gray-600 mb-6 h-24 overflow-y-auto custom-scrollbar"></p>
          <a id="map-link" href="#" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-600 transition-colors"> 地図で見る 🗺️ </a>
        </div>
      </main>

      <footer class="mt-8">
        <button id="gacha-button" class="gacha-button bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold text-2xl py-4 px-10 rounded-full shadow-lg">ガチャを引く！</button>
        <p id="error-message" class="mt-3 text-red-500 font-bold hidden">エラーが発生しました</p>
      </footer>

      <section class="mt-10 w-full max-w-md mx-auto">
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6">
          <h3 class="text-2xl font-bold text-gray-700 mb-4 text-center">コレクション (<span id="collection-count">0</span> / <span id="total-count">0</span>)</h3>
          <div id="collection-grid" class="custom-scrollbar grid grid-cols-3 sm:grid-cols-4 gap-2 text-center max-h-48 overflow-y-auto p-1"></div>
          <button id="reset-collection-button" class="mt-4 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-full hover:bg-red-600 transition-colors text-sm">コレクションをリセット</button>
        </div>
      </section>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 modal-enter">
      <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center">
        <h4 class="text-xl font-bold text-gray-800 mb-2">確認</h4>
        <p class="text-gray-600 mb-6">本当にコレクションをリセットしますか？<br />この操作は元に戻せません。</p>
        <div class="flex justify-center gap-4">
          <button id="cancel-reset-button" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-colors">いいえ</button>
          <button id="confirm-reset-button" class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition-colors">はい、リセットします</button>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const gachaButton = document.getElementById("gacha-button");
      const resultCard = document.getElementById("result-card");
      const initialState = document.getElementById("initial-state");
      const resultState = document.getElementById("result-state");
      const rarityDisplay = document.getElementById("rarity-display");
      const islandName = document.getElementById("island-name");
      const islandPrefecture = document.getElementById("island-prefecture");
      const islandDescription = document.getElementById("island-description");
      const mapLink = document.getElementById("map-link");
      const newBadge = document.getElementById("new-badge");

      // Collection Elements
      const collectionGrid = document.getElementById("collection-grid");
      const collectionCount = document.getElementById("collection-count");
      const totalCount = document.getElementById("total-count");
      const resetCollectionButton = document.getElementById("reset-collection-button");

      // Modal Elements
      const confirmModal = document.getElementById("confirm-modal");
      const confirmResetButton = document.getElementById("confirm-reset-button");
      const cancelResetButton = document.getElementById("cancel-reset-button");

      let collectedIslands = [];
      const STORAGE_KEY = "islandGachaCollection";

      // 日本の島データ
      let islands = [];

      // レアリティの数値からラベルへのマッピング
      const rarityMapping = {
        1: "SSR", // 最高レアリティ
        2: "SR", // 高レアリティ
        3: "R", // レア
        4: "N", // ノーマル
      };

      // DOM 要素
      const loadingIndicator = document.getElementById("loading-indicator");

      // JSONファイルから島データを取得する
      async function loadIslandsData() {
        try {
          const response = await fetch("data/islands.json");
          if (!response.ok) {
            throw new Error("島データの読み込みに失敗しました");
          }
          const data = await response.json();

          // JSONデータを表示用に変換し、必要なプロパティがnullやundefinedでない項目だけを使用
          islands = data
            .filter((island) => island.name && island.prefecture)
            .map((island) => ({
              name: island.name,
              prefecture: island.prefecture,
              description: island.description,
              lat: island.latitude,
              lon: island.longitude,
              rarity: rarityMapping[island.rarity],
            }));

          // 初期化完了後に表示を更新
          totalCount.textContent = islands.length;
          renderCollection();

          // ロード完了後、ローディングインジケータを非表示にする
          if (loadingIndicator) {
            loadingIndicator.style.display = "none";
          }
        } catch (error) {
          console.error("島データの読み込みエラー:", error);
          alert("島データの読み込みに失敗しました。ページを再読み込みしてください。");
        }
      }

      // --- Gacha Logic ---
      function drawGacha() {
        const rarityTable = { SSR: 0.05, SR: 0.1, R: 0.2, N: 0.65 };
        const rand = Math.random();
        let cumulativeProb = 0;
        let selectedRarity = "N";

        for (const rarity in rarityTable) {
          cumulativeProb += rarityTable[rarity];
          if (rand < cumulativeProb) {
            selectedRarity = rarity;
            break;
          }
        }

        const islandsOfRarity = islands.filter((i) => i.rarity === selectedRarity);
        // レアリティに該当する島がない場合は、別のレアリティから選択
        if (islandsOfRarity.length === 0) {
          const allIslands = islands;
          const randomIndex = Math.floor(Math.random() * allIslands.length);
          return allIslands[randomIndex];
        }

        const randomIndex = Math.floor(Math.random() * islandsOfRarity.length);
        return islandsOfRarity[randomIndex];
      }

      // --- Collection Functions ---
      function loadCollection() {
        const data = localStorage.getItem(STORAGE_KEY);
        collectedIslands = data ? JSON.parse(data) : [];
      }

      function saveCollection() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(collectedIslands));
      }

      function renderCollection() {
        collectionGrid.innerHTML = "";
        const rarityOrder = { SSR: 0, SR: 1, R: 2, N: 3 };
        const sortedCollection = [...collectedIslands].sort((a, b) => {
          const rarityDiff = rarityOrder[a.rarity] - rarityOrder[b.rarity];
          if (rarityDiff !== 0) return rarityDiff;
          return islands.findIndex((i) => i.name === a.name) - islands.findIndex((i) => i.name === b.name);
        });

        sortedCollection.forEach((island) => {
          const islandEl = document.createElement("div");
          islandEl.textContent = island.name;
          const rarityClass = `rarity-${island.rarity.toLowerCase()}-bg`;
          islandEl.className = `p-2 rounded-lg text-sm font-semibold truncate text-gray-700 ${rarityClass}`;
          islandEl.title = `${island.rarity} - ${island.name}`;
          collectionGrid.appendChild(islandEl);
        });

        collectionCount.textContent = collectedIslands.length;
      }

      // --- UI Update ---
      function updateResultCard(island) {
        initialState.classList.add("hidden");
        resultState.classList.remove("hidden", "card-reveal");

        // レアリティスタイル更新
        resultCard.className = `backdrop-blur-sm rounded-2xl shadow-2xl p-6 min-h-[300px] flex flex-col justify-center items-center transition-all duration-300 relative rarity-${island.rarity.toLowerCase()}-bg`;
        rarityDisplay.textContent = island.rarity;
        rarityDisplay.className = `font-bold text-2xl mb-2 rarity-${island.rarity.toLowerCase()}-text`;

        islandName.textContent = island.name || "名称不明";
        islandPrefecture.textContent = island.prefecture || "";
        islandDescription.textContent = island.description || "詳細情報はありません。";

        // 緯度と経度の両方があれば地図リンクを有効に、なければ無効に
        if (island.lat && island.lon) {
          mapLink.href = `https://www.google.com/maps?q=${island.lat},${island.lon}&z=11`;
          mapLink.classList.remove("opacity-50", "cursor-not-allowed");
          mapLink.classList.add("hover:bg-blue-600");
          mapLink.removeAttribute("disabled");
        } else {
          mapLink.href = "#";
          mapLink.classList.add("opacity-50", "cursor-not-allowed");
          mapLink.classList.remove("hover:bg-blue-600");
          mapLink.setAttribute("disabled", "true");
        }

        requestAnimationFrame(() => {
          resultState.classList.add("card-reveal");
        });
      }

      // --- Event Listeners ---
      gachaButton.addEventListener("click", () => {
        // 島データが読み込まれていない場合は早期リターン
        if (islands.length === 0) {
          document.getElementById("error-message").classList.remove("hidden");
          document.getElementById("error-message").textContent = "島データが読み込まれていません。ページを再読み込みしてください。";
          return;
        }

        try {
          const selectedIsland = drawGacha();
          if (!selectedIsland || !selectedIsland.name) {
            throw new Error("有効な島データが取得できませんでした");
          }

          const isNew = !collectedIslands.some((item) => item.name === selectedIsland.name);

          if (isNew) {
            collectedIslands.push(selectedIsland);
            saveCollection();
            renderCollection();
            newBadge.classList.remove("hidden");
          } else {
            newBadge.classList.add("hidden");
          }

          updateResultCard(selectedIsland);
          // エラーメッセージを非表示
          document.getElementById("error-message").classList.add("hidden");
        } catch (error) {
          console.error("ガチャ実行エラー:", error);
          document.getElementById("error-message").classList.remove("hidden");
          document.getElementById("error-message").textContent = "ガチャの実行中にエラーが発生しました。";
        }
      });

      resetCollectionButton.addEventListener("click", () => {
        confirmModal.classList.remove("hidden");
      });

      cancelResetButton.addEventListener("click", () => {
        confirmModal.classList.add("hidden");
      });

      confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
          confirmModal.classList.add("hidden");
        }
      });

      confirmResetButton.addEventListener("click", () => {
        collectedIslands = [];
        saveCollection();
        renderCollection();
        confirmModal.classList.add("hidden");
      });

      // --- Initialization ---
      async function init() {
        try {
          await loadIslandsData();
          if (islands.length === 0) {
            throw new Error("有効な島データが見つかりませんでした");
          }

          // ロード完了表示
          gachaButton.disabled = false;
          gachaButton.classList.remove("opacity-50", "cursor-not-allowed");

          loadCollection();
          renderCollection();
        } catch (error) {
          console.error("初期化エラー:", error);
          loadingIndicator.textContent = "データの読み込みに失敗しました。再読み込みしてください。";
          loadingIndicator.classList.remove("text-blue-500");
          loadingIndicator.classList.add("text-red-500");

          // ガチャボタンを無効化
          gachaButton.disabled = true;
          gachaButton.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      // 読み込み開始
      init();
    </script>
  </body>
</html>
